Author: Joseph Lee
E-Mail: fdlixiaojun@gmail.com

建立TCP连接的三步握手
01) 服务器被动打开
02) 客户调用connect。发送SYN(J)
03) 服务器确认客户端的SYN(J)，并向客户发送SYN(K)，即SYN(K), ACK(J+1)，一般为一个分组
04) 客户确认服务器的SYN(K)，发送ACK(K+1)，连接建立。

SYN中可以有若干TCP选项，常用的有:
  MSS选项，通知对方自己的最大分节大小MSS(maximum segment size)
  窗口规模选项，通知对方自己的最大窗口大小，窗口可扩大（高速或长延迟情况下）
  时间戳选项，高速连接情况下

TCP四步终止连接
01) 调用close，active close，发送FIN
02) passive close，确认对方的FIN，并将其作为文件结束符传给应用进程
03) 应用进程调用close，发送FIN
04) （主动关闭方）确认FIN。

通常是客户端执行主动关闭，但某些协议，比如HTTP是服务器执行主动关闭。

TIME_WAIT状态，执行主动关闭的一方在4步终止交互完成后进入TIME_WAIT状态，这么做
的目的有二：一是实现终止TCP全双工连接的可靠性，即可以保证重发最后一个ACK；二是允许老的重复分组在网络中消逝，即保证连接关闭后存在于网络中的分组有足够的时间超时消失，不至于影响后面建立的连接。

临时端口范围 49152-65535。
IPv4数据报的最大大小为65535字节，包括IPv4头部。

从进程到内核传递套接口地址结构的4个套接口函数：bind，connect，sendto，sendmsg。即在这里把填充好的地址结构传递给内核来处理。
从内核到进程传递套接口地址结构的5个套接口函数：accept, recvfrom, recvmsg, getpeername, getsockname，即地址结构从这里传递指针进去，然后被填充后返回。

为什么引入通用套接口地址结构struct sockaddr
ANSI C有通用指针类型void *，但套接口函数是在ANSI C之前定义的，所以采用了定义通
用地址结构的方法来访问不同地址族的的地址结构。
从应用程序开发人员的角度来看，通用的套接口地址结构的唯一用途是给指向特定于协议
的地址结构的指针转换类型。
从内核的角度看，使用指向通用套借口地址结构指针的原因是，内核必须依据调用者的指
针，将其转换为struct sockaddr *类型，然后检查sa_family的值来确定结构的类型。

为什么有时需要传递套接口地址结构长度给bind等函数？
对于IPv4，IPv6，UNIX域，前两者的地址长度是固定的，而后两者的地址长度
是可变的，所以需要显示传递。


---------------------------------------
References:
UNP Chapter 2 传输层: TCP UDP

