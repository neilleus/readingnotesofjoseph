Author: Joseph Lee
E-Mail: fdlixiaojun@gmail.com

文件系统

为什么要有文件的概念？
因为主存：容量有限制，不能长期保存，信息共享困难

文件命名，文件结构，文件类型，文件访问，文件属性，文件操作
文件名长度，文件扩展名，文件名的组成字符和大小写区分
常用的三种文件结构：（1）无结构字节流；（2）固定长度记录；（3）关键字索引
的不固定长度记录树
操作系统不关心文件的结构，对于操作系统来说，文件就是字节流。
文件类型：常规文件、目录文件，设备文件等
文件访问：顺序访问（如串口）和随机访问（如磁盘）
文件属性：权限，时间，长度等
文件操作：创建，删除，打开，关闭，读写等

目录和文件夹，目录项，目录结构，路径名，目录操作
许多系统中，目录也是文件，目录包含目录项。
目录项的两种形式：（1）包含名字和数据结构信息（2）包含名字和指向数据结构的指针
目录结构：（1）单一目录；（2）二级目录；（3）树状层次目录系统
路径名：绝对路径和相对路径，特殊目录项.和..；
目录操作：创建、删除、打开，关闭，读取，重命名，增加目录项，删除目录项

磁盘和文件系统基础
磁盘扇区0称为主引导记录（Master Boot Record MBR）。
MBR的末尾有一个分区表，里面记录了每一个分区的起始地址和结束地址。
在这些分区中有一个是活动分区，即启动时要引导的分区。启动时MBR程序确定活动分
区，读入其第一个磁盘扇区（引导扇区），然后执行它。
每个分区都以一个引导扇区开头，即使该分区没有可引导的系统，最好也预留引导扇区。
在PC机上，主要分区个数最多不操作4个，因为主引导记录和第一个512字节的扇区末尾之
间仅能容纳4个数组元素（每个16字节）来存放分区描述符。有些操作系统可以将分区表
中的某一项（某个主分区）作为一个扩展分区，指向一个逻辑分区链表，这样可以实现任
意多个分区。不过，BIOS只能从主分区来启动一个操作系统，即最初的启动必须是从主分
区开始。由它来装入代码，管理各个逻辑分区。
不是所有磁盘都需要分区，BIOS读入磁盘的第一个扇区，然后查找一个魔数，标志它是有
效的可执行代码，主引导记录和引导扇区使用相同的魔数。
无论哪种操作系统或硬件平台，上述关于磁盘MBR和引导扇区的描述都适用。
与引导扇区的启动不同，不同文件系统的磁盘分区布局（引导扇区后的扇区分配）各不同。
一个UNIX文件系统的可能结构：
    +------+------+------------+--------+------+----------+
    |引导块|超级块|空闲空间管理|索引节点|根目录|文件和目录|
    +------+------+------------+--------+------+----------+
磁盘分区的类型（主分区，扩展分区，文件系统类型）由分区表中的一字节代码来判断。
分区上的磁盘空间管理，访问全乡以及目录查找等是由分区上所安装的文件系统实现的。
一个硬盘上只能有一个主分区作为扩展分区，扩展分区理论上可以分出任意多个子分区。
为什么要分区？
可以方便的区分操作系统的系统文件和用户文件
可以实现虚拟存储器的交换分区
可以将日志和缓存等独立出来
可以实现多步启动，允许引导多种操作系统
可以方便的保护和隔离文件

文件实现：如何分配磁盘扇区给文件
连续分配：简单高效；碎片问题；大小指定问题，文件难更改；只读文件系统可方便应用
链表分配：每块第一个字节用作指针指向下一个块；无碎片；随机访问速度慢；破坏了磁
盘扇区大小正好是2的整数幂这一特点，导致效能降低。
带文件分配表的链表结构：将上面方案中的链表指针抽取出来单独存放到一张表（FAT表）
中，将该表放在内存中。无碎片问题；随机访问只需遍历内存中的表格；整个磁盘扇区用
于数据存储；内存中要保存一张表，内存空间耗费。Windows的FAT文件系统采用这种方案
索引节点：为每个文件赋予一个数据结构称为索引节点（i节点），里面列出了文件的属
性和各个数据块的磁盘地址。只在文件打开时才将数据结构装入内存，与FAT相比内存耗
费小；i节点存放的磁盘块数量有限，大文件有问题，引入二级、三级间接块解决该问题。

目录实现
如何定位根目录？
UNIX通过超级块，通过第一个i节点（指向根目录）得到根目录位置。
Windows XP根据引导扇区中的信息找到主文件表（MFT），然后用它定位文件系统其他部分
定位根目录后可对目录树搜索，定位文件。
文件属性存放位置：目录项；i节点；
共享文件：目录项指向同一i节点；符号链接（文件内容为另一文件的路径名）；
Win98的目录：杂合体
UNIX的目录：目录项包含i节点号和文件名，文件属性存放在i节点中。
NTFS的目录：通过增加属性来解决问题；MFT主文件表；保护系统；加密和压缩等功能。

