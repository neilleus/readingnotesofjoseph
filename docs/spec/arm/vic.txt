ARM-VIC

------------------------------------------------------------------------------
PrimeCell VIC在两个方面提高了中断系统性能：
	将中断控制器转移到AMBA AHB总线  ?why?
	为所有中断源提供中断向量支持
	支持ARM v6处理器

概述
	在有中断控制器的系统中，软件需要确定中断源和中断处理程序的位置，VIC在
	硬件中完成了这两件事情的处理。它提供了当前最高优先级的中断请求对应的
	中断处理程序的开始地址（或者向量地址）。

	如果系统不支持中断向量地址，VICVECTADDR寄存器组可以编程为相关中断号，
	以便快速确定中断源。

	IRQ和FIQ请求逻辑到nVICIRQ和nVICFIQ的路径是异步的，这允许在省电模式下
	（AHB时钟HCLK已经关闭）发出中断。电源控制逻辑则会在收到中断后打开处理
	器和VIC AHB时钟，以执行中断处理程序。

	根据约定，IFQ中断的1-5位应该按照规定使用，位0和6以上可以按照需求来定
	义。对于FIQ中断，则所有位都可以使用。

优先级逻辑：
	两级优先级，软件优先级和硬件优先级
	掩码：软件优先级存在掩码，可以确定是否应用软件优先级。
	两种优先级掩码方式，软件掩码（可编程控制）和硬件掩码（硬件内置）
		硬件掩码: 不管中断是否被处理，是否读取了VICADDRESS寄存器，不管
			是否设置了VICIRQACK，都会应用的掩码。硬件掩码用来防止
			其他相同或者低优先级的中断打断当前正在执行的ISR。当ISR
			结束或者向VICADDRESS中写入以后，该掩码被清除，允许所有
			中断通过。VICIRQSTATUS和 VICRAWINTR不受此掩码影响
		软件掩码: 该掩码使用写入到VICSWPRIORITYMASK中的值。这个掩码会
			被一直应用。VICIRQSTATUS和VICRAWINTR的值不反映这个掩码
	优先级确定: 相同编码优先级的中断请求，通过判断硬件优先级来确定谁先处
		理，当已经开始处理时，产生了相同编码优先级的中断请求，则等待
		ISR完成，而不管硬件优先级。
	硬件优先级排序:
		FIQ>IRQ0>...>IRQ31>daisy-chain int
	注意: VICSWPRIORITYMASK和软件中断并没有直接的联系，它指的是软件掩码。

软件中断：
	软件可以控制软件中断线产生软件中断。该中断在掩码前产生，然后和外部中断
	一样需要经过掩码处理。软件中断通过想软件中断清除寄存器VICSOFTINTCLEAR
	写入清除，通常在ISR末尾做。

ISR地址:
	VICADDRESS提供当前中断的ISR的地址，它同VICVECTADDROUT端口有相同值。这
	个值反应了从32个VICVECTADDR寄存器经过编码处理后的值或者从daisy-chain输
	入的值。如果当前没有中断，则VICADDRESS寄存器保存前一个活跃中断地址。
	向量中断地址寄存器必须用对应的向量中断源的ISR地址填充，如果多个中断源
	共用相同的ISR，则要把相同的地址填到各自对应的寄存器中。
	对于不能使用向量地址信息的系统，这些寄存器可以保留缺省值或者填充中断
	源号。
	注意VICADDRESS有读写条件和时间点限制。

中断流程：
	向量中断流程--使用AHB
		中断产生
		arm处理器跳转到IRQ中断向量地址
		读取VICADDRESS寄存器跳转到中断处理程序。可以通过使用LDR PC指
		令。读取VICADDRESS寄存器会更新中断控制器的硬件优先级寄存器
		保存现场，入栈
		打开处理器中断以保证高优先级中断抢占
		执行ISR
		清除中断
		关处理器中断并恢复现场
		向VICADDRESS写入，清楚内部中断优先级硬件逻辑
		中断返回，打开中断。

	非向量中断流程--使用AHB
		中断产生
		arm处理器跳转到IRQ中断向量地址
		保存现场
		空读VICADDRESS，在VIC内建立优先级状态控制信息
		读VICRQSTATUS寄存器，决定中断源
		执行ISR，在ISR开始部分可以打开中断保证高优先级中断可抢占。
		清除中断
		关中断恢复现场
		向VICADDRESS写入，清除内部中断优先级信息
		中断返回，打开中断

	FIQ流程
		FIQ中断产生
		ARM处理器跳转到FIQ中断向量地址
		跳转到ISR
		执行ISR
		清除中断
		关中断恢复现场
		中断返回打开中断
		注意：这里不可以读写VICADDRESS寄存器

	向量中断处理流程--使用VIC端口（CPU支持VIC接口）
		IRQ 中断产生
		使用VICRQACK和VICVECTADDRV信号与VIC握手以更新中断控制器的硬件
			优先级寄存器，包含了通过VICVECTADDROUT端口读取向量地
			址。握手结束时跳转到中断处理程序地址。中断接收到时，这
			个操作由处理器自动完成。
		保存现场
		开中断，以便高级中断可以抢占
		执行ISR
		清除中断
		关中断恢复现场
		向VICADDRESS寄存器写入。这会清除对应中断的硬件优先级逻辑
		中断返回开中断。
	使用VIC端口解释：
		PrimeCell VIC向ARM11和ARM1026EJ处理器提供了对VIC端口的执行访
		问。这提供了不使用AHB访问向量中断地址和确认中断服务的方法，可
		以减少中断延迟。使用VIC端口直接获得向量中断地址减少了中断服务
		的延迟，因为处理器不再需要通过AHB访问VICADDRESS寄存器。而这个
		时间受到了AHB上当前访问情况的影响。
		当一个向量IRQ触发，CPU通过VICVECTADDROUT黛西链总线读取地址。这
		个包含了和VICADDRESS寄存器等价的信息。更新中断控制器硬件优先级
		寄存器和清除嵌套中断: 处理器将VICRQACK信号设置为高电平指明中断
		已经被检测到。VIC设置VICVECTADDRV为高电平指明向量地址有效稳
		定。处理器采样向量地址并取消VICIRQACK。VIC取消nIRQ和
		VICVECTADDRV信号。这个过程等价于读取VICADDRESS寄存器。
		注意：必须在ISR最后使用AHB向VICADDRESS寄存器写入来通知中断
		已经处理。
		保证ARM处理器的CP15寄存器1 VE，VIC Enable位被置位。如果没设使
		用传统方法，设了使用VIC端口获取IRQ向量地址。VE位复位为0。

连接：
	PrimeCell VIC正常情况下是独立的中断控制器。如果有需要，可以用黛西链与
	另外一个中断控制器连接，比如另外一个PL192，一个PL190或者一个ADK中断
	控制器。
	注意：如果使用了daisy chaining，中断延迟会增加。
	PrimeCell VIC作为一个标准AHB附件连接到处理器，FIQ和IRQ信号连接到处理
	器的FIQ和IRQ输入。外设的中断请求线连接到VIC的VICINTSOURCE输入，未使用
	的中断输入连接到低电平。为了保证能在一个单指令周期内读取VICADDRESS，
	PrimeCell VIC必须在内存的高4K地址空间，对于正常异常向量在0xFFFFF000，
	对于高异常向量在0xFFFEF000。这个4K的原因是LDR指令的地址宽度是12位，范
	围为4K。如果地址距离大于4K的话，需要第二条指令来通过完整的地址访存。当
	一个中断发生时，当前地址是IRQ或者FIQ的异常向量位置（0x00000018或
	者0x0000001C在正常低异常向量情况下）。如果处理器支持高异常向量并且配
	置pin脚HIVECS连接到高电平，则VIC必须位于0xFFFEF000以允许异常向量位于
	0xFFFFF000，VIC不能位于0x00000000，因为这里是系统内存的标准位置。特定
	寄存器到基地址的偏移都是固定的。
	由于ARM11和ARM1026EJ处理器直接访问中断地址而不是通过VICADDRESS寄存器，
	所以它们可以映射到其他位置。

	数种连接方式
		单中断控制器连接到无VIC端口的处理器
		黛西链中断控制器连接到无VIC端口的处理器
		黛西链的VIC模式
		VIC端口连接方式

中断延迟
	几大影响因素：
		核心延迟（处理器类型和功能）：中断是异步事件，处理器需要同步该
			事件（即执行完当前指令以及相应流水线处理）；寄存器加载
			需要时间。
		存储系统和周期类型：存储器访问需要大量处理器时钟周期
		紧耦合存储：增加0延迟的存储，用来为时间紧要的处理减小存储延迟。
		缓存：缓存flush增加了存储时间开销
		编译器优化
	性能优化：
		PrimeCell VIC允许高优先级中断中断低优先级中断。所以可以在处理
		器进入ISR之后重新打开中断。这样可以提高系统响应能力。在中断使
		能比特可以重新打开之前，LR和SPSR必须先保存，最好保存在软件栈
		上，当ISR退出时，中断必须关闭，恢复LR和SPSR，然后向VICADDRESS
		寄存器写入。

PL192和PL190: 
	二者软件不兼容
	PL192有32个向量中断，而PL190只有16个向量中断。
	在固定的硬件优先级上增加了16级可编程优先级和对应掩码。
	VICIRQINREG和OUTREG用来实现daisy-chain

寄存器说明，功能和读写状态：
	VICIRQSTATUS: 经VICINTENABLE和VICINTSELECT掩码后的中断状态，只读
	VICFIQSTATUS: 经VICINTENABLE和VICINTSELECT掩码后的中断状态，通常应该
		只有一个FIQ类型的中断，如果有多个FIQ类型的中断，FIQ处理函数通
		过读取这个寄存器来确定中断源。只读
	VICRAWINTR: 未经掩码的中断状态。只读
	VICINTSELECT: 确定是FIQ还是IRQ中断。读写
	VICINTENABLE: 通过它打开某个中断。读写
	VICINTENCLEAR: 通过它关闭某个中断。只写
	VICSOFTINT: 通过它产生软件中断（写）和判断软件中断状态（读）。读写
	VICSOFTINTCLEAR:  通过它清楚软件中断。只写
	VICPROTECTION: 当处理器位于用户模式时，用来确定是否允许寄存器访问。读写
	VICADDRESS: 包含当前处理中断的ISR地址，如果当前没有中断活跃，包含最近
		一个活跃中断ISR的地址。读只可以在当前有活跃中断时读，向该寄存
		器写入任意值将会清除当前中断，只可以在ISR最后写入。从该寄存器
		读用来通知硬件优先级逻辑模块，中断正在处理，向该寄存器写用来通
		知硬件优先级逻辑模块，中断已经处理完毕。不可以在其他时刻读写该
		寄存器。读写
	VICSWPRIORITYMASK: 该寄存器包含了中断优先级的掩码状态，即是否启用软件
		优先级。读写
	VICVECTADDR[0-31]: 这个寄存器组包含了对应的ISR地址。该寄存器组必须在对
		应的中断禁止的情况下才可以更新，对于不支持中断向量地址的系统，
		可以在其中写入对应的中断号，这样可以方便的确定当前的活跃中断。
		读写
	VICVECTPRIORITY[0-31]: 用来设置和确定32个向量中断源的优先级。从0-15共
		16级。最高级是0，15是最低级，也是复位值。VSC7501的是8级。这些
		寄存器仅有低4位有效，高28位保留使用。读写。

杂碎点：
	时间短暂的中断：
		存在时间极短的中断也会被VIC报告给CPU并处理到，但是由于没有设置
		中断优先级，所以它可以被任何中断中断，有点像允许中断嵌套一样。
	一个IRQ中断能够产生的条件有：
		它被enable了，VICINTENABLE
		被设置为IRQ方式，VICINTSELECT
		中断优先级没有被软件优先级掩码寄存器屏蔽，VICSWPRIORITYMASK。
